<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>National Lottery Header</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    
    <button id="connect">Connect MetaMask</button>
    

    <header class="header">
        <div class="logo-container">
            <img src="logo.png" alt="The National Lottery" class="logo">
        </div>
        <div class="button-container">
            <div class="balance-button">
                <span id="balance">0.00 €</span>
                <button onclick="refreshBalance()" class="refresh-icon">&#8635;</button>
            </div>
            <button class="profile-button">Profil</button>
            <button class="logout-button">Se déconnecter</button>
        </div>
    </header>

    <!-- Barre de navigation avec boutons -->
    <nav class="nav-buttons">
        <button class="nav-button">RÉSULTATS</button>
        <button class="nav-button">ACHAT DE BILLETS</button>
        <button class="nav-button">JEUX EN LIGNE</button>
        <button class="nav-button">PROMOTIONS</button>
        <button class="nav-button">POINTS CHANCEUX</button>
        <img src="logo-zebet.png" alt="ZEbet Logo" class="zebet-logo">
    </nav>

    <!-- Section d'informations sur le tirage -->
    <section class="lottery-info">
        <div class="lottery-details">
            <label for="lottery-select" class="lottery-label">CHOISIR UN TIRAGE</label>
            <select id="lottery-select" class="lottery-select">
                <option value="1">Mardi 30 juillet 2024 à 20h10</option>
            </select>
            <span class="countdown-text">TIRAGE AU SORT DANS 2 JOURS ET 1 HEURE</span>
        </div>

        <div class="prize">
            <span class="prize-label">PRIX</span>
            <span class="prize-value">20 000€</span>
        </div>

        <div class="ticket-price">
            <span class="ticket-label">PRIX PAR BILLET</span>
            <span class="ticket-value">2,00€</span>
        </div>
    </section>

    <!-- Conteneur pour les sections "Entrée de Numéro de Ticket" et "Mes Billets" -->
    <div class="main-container">
        <!-- Section d'entrée de numéro de ticket à gauche -->
        <section class="ticket-section">
            <div class="ticket-input">
                <h3>ENTREZ VOTRE NUMÉRO DE TICKET</h3>
                <div class="ticket-numbers">
                    <input type="text" maxlength="1" class="ticket-number" aria-label="Numéro de ticket 1">
                    <input type="text" maxlength="1" class="ticket-number" aria-label="Numéro de ticket 2">
                    <input type="text" maxlength="1" class="ticket-number" aria-label="Numéro de ticket 3">
                    <input type="text" maxlength="1" class="ticket-number" aria-label="Numéro de ticket 4">
                    <input type="text" maxlength="1" class="ticket-number" aria-label="Numéro de ticket 5">
                    <input type="text" maxlength="1" class="ticket-number" aria-label="Numéro de ticket 6">
                </div>
                <button class="search-button">NUMÉRO DE RECHERCHE</button>
            </div>

            <!-- Section de sélection des billets -->
            <div class="ticket-selection">
                <h3>CHOISISSEZ VOTRE/VOS BILLET(S)</h3>
                <div class="ticket-list">
                    <div class="ticket-card">
                        <img src="ticket1.png" alt="Ticket Image">
                        <button class="add-to-cart">AJOUTER AU PANIER</button>
                    </div>
                    <div class="ticket-card">
                        <img src="ticket1.png" alt="Ticket Image">
                        <button class="add-to-cart">AJOUTER AU PANIER</button>
                    </div>
                    <div class="ticket-card">
                        <img src="ticket1.png" alt="Ticket Image">
                        <button class="add-to-cart">AJOUTER AU PANIER</button>
                    </div>
                    <div class="ticket-card">
                        <img src="ticket1.png" alt="Ticket Image">
                        <button class="add-to-cart">AJOUTER AU PANIER</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section "Mes Billets" à droite -->
        <section class="ticket-summary">
            <h3>MES BILLETS :</h3>
            <div class="summary-item">
                <span class="summary-label">SOUS-TOTAL :</span>
                <span class="summary-value">1,00 €</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">REMISE :</span>
                <span class="summary-value">0,00 €</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">TOTAL :</span>
                <span class="summary-value">1,00 €</span>
            </div>
            
            <button id="buy-ticket" class="buy-ticket">PROCÉDER AU PAIEMENT</button>
            <div class="ticket-numbers-summary">
                <span>BULLETINS :</span>
                <span class="ticket-numbers">2 2 0 7 8 3</span>
            </div>
        </section>
    </div>


    <!-- Include Web3.js -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.3/dist/web3.min.js"></script>

    <script>
        let web3;
        let userAddress;
        let contract;
        let isMetaMaskConnected = false; // Track if MetaMask is connected
        let isPermissionRequested = false; // Track if permissions have been requested

        // Check if MetaMask is installed
        if (typeof window.ethereum !== 'undefined') {
            web3 = new Web3(window.ethereum);
            
            // Listen for MetaMask account changes
            ethereum.on('accountsChanged', (accounts) => {
                userAddress = accounts[0];
                console.log('Account changed to:', userAddress);
            });

            ethereum.on('chainChanged', (chainId) => {
                console.log('Network changed to:', chainId);
            });

            // Request account access when the "Connect MetaMask" button is clicked
            document.getElementById('connect').addEventListener('click', async () => {
                if (!isPermissionRequested) {
                    try {
                        isPermissionRequested = true;  // Flag to prevent multiple requests

                        // Request account access from MetaMask
                        const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
                        userAddress = accounts[0];  // Get the connected account address
                        console.log('Connected account:', userAddress);

                        // Enable the "Buy Ticket" button
                        document.getElementById('buy-ticket').disabled = false;
                        alert('MetaMask connected. Account: ' + userAddress);

                        // Initialize the contract instance with the provided contract ABI and address
                        const contractAddress = '0x2F7Ca7235e033a49518A814f602965046D31FA09';  // Replace with your contract's address
                        const contractABI = [
                            {
                                "inputs": [],
                                "name": "buyTicket",
                                "outputs": [],
                                "stateMutability": "payable",
                                "type": "function"
                            }
                        ];

                        // Create a contract instance
                        contract = new web3.eth.Contract(contractABI, contractAddress);
                    } catch (error) {
                        console.error('Error connecting to MetaMask:', error);
                        alert('Error: Unable to connect to MetaMask');
                    }
                } else {
                    alert('MetaMask is already connected!');
                }
            });

            // Listen for "Buy Ticket" button click to send a transaction
            document.getElementById('buy-ticket').addEventListener('click', async () => {
                if (!userAddress || !contract) {
                    alert('Please connect to MetaMask first!');
                    return;
                }

                try {
                    // Call the buyTicket method of the contract
                    await contract.methods.buyTicket().send({
                        from: userAddress,  // The connected MetaMask account
                        value: web3.utils.toWei('0.01', 'ether')  // Sending 1 Ether
                    });

                    alert('Ticket purchased successfully!');
                    console.log('Transaction successful');
                } catch (error) {
                    console.error('Error buying ticket:', error);
                    alert('Error: Unable to purchase ticket.');
                }
            });
        } else {
            alert('Please install MetaMask!');  // MetaMask not detected
        }
    </script>
    <script src="script.js"></script>
</body>
</html>
